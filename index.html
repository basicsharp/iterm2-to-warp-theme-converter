<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iTerm2 to Warp Theme Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        textarea {
            font-family: 'Fira Code', monospace;
        }
        a {
            /* color: #93c5fd !important; Tailwind 'blue-300' */
            text-decoration-line: underline !important;
            text-decoration-style: dotted !important;
            text-underline-offset: 3px !important;
            transition: color 0.2s ease-in-out !important;
        }
        a:hover {
            color: #60a5fa; /* Tailwind 'blue-400' */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col min-h-screen">
    <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header Section -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">iTerm2 to Warp Theme Converter</h1>
            <p class="mt-2 text-lg text-gray-400">Instantly convert your favorite <code class="bg-gray-700 text-sm rounded-md px-1 py-0.5">.itermcolors</code> themes to the Warp <code class="bg-gray-700 text-sm rounded-md px-1 py-0.5">.yml</code> format.</p>
        </div>

        <!-- Main Converter UI -->
        <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-4 sm:p-6 lg:p-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Input Column -->
                <div class="flex flex-col space-y-4">
                    <div class="flex justify-between items-center">
                         <h2 class="text-xl font-semibold text-white">1. Input iTerm2 Theme</h2>
                         <label for="file-upload" class="cursor-pointer text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                            Upload .itermcolors
                         </label>
                         <input id="file-upload" type="file" class="hidden" accept=".itermcolors">
                    </div>
                    <p class="text-sm text-gray-400">Paste your <code class="bg-gray-700 text-xs rounded-md px-1">.itermcolors</code> file content below or upload it.<br/>Grab some from <a href="https://iterm2colorschemes.com/">iterm2colorschemes.com</a></p>
                    <textarea id="iterm-input" class="w-full h-96 flex-grow bg-gray-900 border border-gray-600 rounded-lg p-4 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Paste your .itermcolors XML content here..."></textarea>
                    <button id="convert-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 text-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m11 17 5-5-5-5"/><path d="m18 17 5-5-5-5"/></svg>
                        Convert to Warp Theme
                    </button>
                </div>

                <!-- Output Column -->
                <div class="flex flex-col space-y-4">
                    <h2 class="text-xl font-semibold text-white">2. Output Warp Theme</h2>
                    <p class="text-sm text-gray-400">Your generated <code class="bg-gray-700 text-xs rounded-md px-1">.yml</code> theme. Save this as a file in your <code class="bg-gray-700 text-xs rounded-md px-1">~/.warp/themes/</code> directory.<br/>Check <a href="https://docs.warp.dev/terminal/appearance/custom-themes">Warp custom theme docs</a> for more info.</p>
                    <textarea id="warp-output" readonly class="w-full h-96 flex-grow bg-gray-900 border border-gray-600 rounded-lg p-4 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Warp YAML output will appear here..."></textarea>
                    <button id="copy-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 text-lg flex items-center justify-center" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                        Copy to Clipboard
                    </button>
                </div>
            </div>
            <!-- Status/Error Message Area -->
            <div id="status-message" class="mt-6 text-center text-sm"></div>
        </div>

        <!-- Instructions Section -->
        <div class="mt-8 text-center text-gray-400">
            <h3 class="text-lg font-semibold text-white mb-2">How to use your new theme:</h3>
            <ol class="list-decimal list-inside inline-block text-left">
                <li>Click "Copy to Clipboard" or manually copy the output.</li>
                <li>Create a new file, e.g., <code class="bg-gray-700 text-xs rounded-md px-1">my-theme.yml</code>, in <code class="bg-gray-700 text-xs rounded-md px-1">~/.warp/themes/</code>.</li>
                <li>Paste the copied content into the new file and save.</li>
                <li>Open Warp's settings (Cmd+,), go to Appearance, and select your new theme!</li>
            </ol>
        </div>
    </main>

    <footer class="text-center p-4 text-gray-500 text-sm">
        <p>Vibed with ❤️ by <a href="https://github.com/basicsharp">Porramate Lim</a>.</p>
    </footer>

    <script>
        // DOM element references
        const itermInput = document.getElementById('iterm-input');
        const warpOutput = document.getElementById('warp-output');
        const convertBtn = document.getElementById('convert-btn');
        const copyBtn = document.getElementById('copy-btn');
        const fileUpload = document.getElementById('file-upload');
        const statusMessage = document.getElementById('status-message');

        // --- Core Conversion Logic ---

        /**
         * Converts RGB components (0.0-1.0) to a hex color string.
         * @param {number} r - Red component (0.0 to 1.0)
         * @param {number} g - Green component (0.0 to 1.0)
         * @param {number} b - Blue component (0.0 to 1.0)
         * @returns {string} The hex color string (e.g., "#RRGGBB").
         */
        const toHex = (r, g, b) => {
            const to255 = (v) => Math.round(parseFloat(v) * 255);
            const toHexPart = (v) => to255(v).toString(16).padStart(2, '0');
            return `#${toHexPart(r)}${toHexPart(g)}${toHexPart(b)}`;
        };

        /**
         * Parses a <dict> element from the iTerm XML to extract its color.
         * @param {Element} dictElement - The <dict> XML element.
         * @returns {string|null} The hex color string or null if parsing fails.
         */
        const getColorFromDict = (dictElement) => {
            if (!dictElement) return null;
            const keys = dictElement.getElementsByTagName('key');
            const reals = dictElement.getElementsByTagName('real');
            const color = {};
            for (let i = 0; i < keys.length; i++) {
                const key = keys[i].textContent;
                const value = reals[i].textContent;
                if (key === 'Red Component') color.r = value;
                if (key === 'Green Component') color.g = value;
                if (key === 'Blue Component') color.b = value;
            }
            if (color.r !== undefined && color.g !== undefined && color.b !== undefined) {
                return toHex(color.r, color.g, color.b);
            }
            return null;
        };
        
        /**
         * Determines if a color is light or dark to set the 'details' property.
         * @param {string} hex - The hex color string.
         * @returns {'darker' | 'lighter'}
         */
        const getDetailsValue = (hex) => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            // Using the luminance formula
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? 'darker' : 'lighter';
        };

        /**
         * Formats the JavaScript theme object into a YAML string.
         * @param {object} theme - The theme object.
         * @returns {string} The formatted YAML string.
         */
        const toYaml = (theme) => {
            return `
# Generated by iTerm2 to Warp Theme Converter
accent: '${theme.accent}'
background: '${theme.background}'
foreground: '${theme.foreground}'
cursor: '${theme.cursor}'
cursor_text: '${theme.cursor_text}'
selection_background: '${theme.accent}'
selection_text: '${theme.selection_text}'
details: '${theme.details}'

terminal_colors:
  normal:
    black:   '${theme.terminal_colors.normal.black}'
    red:     '${theme.terminal_colors.normal.red}'
    green:   '${theme.terminal_colors.normal.green}'
    yellow:  '${theme.terminal_colors.normal.yellow}'
    blue:    '${theme.terminal_colors.normal.blue}'
    magenta: '${theme.terminal_colors.normal.magenta}'
    cyan:    '${theme.terminal_colors.normal.cyan}'
    white:   '${theme.terminal_colors.normal.white}'
  bright:
    black:   '${theme.terminal_colors.bright.black}'
    red:     '${theme.terminal_colors.bright.red}'
    green:   '${theme.terminal_colors.bright.green}'
    yellow:  '${theme.terminal_colors.bright.yellow}'
    blue:    '${theme.terminal_colors.bright.blue}'
    magenta: '${theme.terminal_colors.bright.magenta}'
    cyan:    '${theme.terminal_colors.bright.cyan}'
    white:   '${theme.terminal_colors.bright.white}'
`.trim();
        };

        /**
         * Main function to handle the conversion process.
         */
        const handleConvert = () => {
            const itermXml = itermInput.value;
            if (!itermXml.trim()) {
                showStatus("Input is empty. Please paste your theme content.", "error");
                return;
            }

            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(itermXml, "application/xml");
                
                if (xmlDoc.getElementsByTagName("parsererror").length) {
                    throw new Error("Invalid XML. Please check the pasted content.");
                }

                const keys = xmlDoc.getElementsByTagName('key');
                const warpTheme = {
                    terminal_colors: { normal: {}, bright: {} }
                };

                const iTermToWarpMap = {
                    'Ansi 0 Color': 'normal.black',
                    'Ansi 1 Color': 'normal.red',
                    'Ansi 2 Color': 'normal.green',
                    'Ansi 3 Color': 'normal.yellow',
                    'Ansi 4 Color': 'normal.blue',
                    'Ansi 5 Color': 'normal.magenta',
                    'Ansi 6 Color': 'normal.cyan',
                    'Ansi 7 Color': 'normal.white',
                    'Ansi 8 Color': 'bright.black',
                    'Ansi 9 Color': 'bright.red',
                    'Ansi 10 Color': 'bright.green',
                    'Ansi 11 Color': 'bright.yellow',
                    'Ansi 12 Color': 'bright.blue',
                    'Ansi 13 Color': 'bright.magenta',
                    'Ansi 14 Color': 'bright.cyan',
                    'Ansi 15 Color': 'bright.white',
                    'Background Color': 'background',
                    'Foreground Color': 'foreground',
                    'Cursor Color': 'cursor',
                    'Cursor Text Color': 'cursor_text',
                    'Selection Color': 'accent',
                    'Selected Text Color': 'selection_text',
                };

                for (const key of keys) {
                    const keyName = key.textContent;
                    const warpName = iTermToWarpMap[keyName];
                    if (warpName) {
                        const dict = key.nextElementSibling;
                        const color = getColorFromDict(dict);
                        if (color) {
                            if (warpName.includes('.')) {
                                const [group, name] = warpName.split('.');
                                warpTheme.terminal_colors[group][name] = color;
                            } else {
                                warpTheme[warpName] = color;
                            }
                        }
                    }
                }
                
                // Set defaults for any missing essential colors
                warpTheme.background = warpTheme.background || '#000000';
                warpTheme.foreground = warpTheme.foreground || '#FFFFFF';
                warpTheme.accent = warpTheme.accent || warpTheme.terminal_colors.normal.blue || '#528BFF';
                warpTheme.cursor = warpTheme.cursor || warpTheme.foreground;
                warpTheme.cursor_text = warpTheme.cursor_text || warpTheme.background;
                warpTheme.selection_text = warpTheme.selection_text || warpTheme.background;

                // Determine 'details' based on background luminance
                warpTheme.details = getDetailsValue(warpTheme.background);

                const yamlOutput = toYaml(warpTheme);
                warpOutput.value = yamlOutput;
                copyBtn.disabled = false;
                showStatus("Conversion successful!", "success");

            } catch (error) {
                showStatus(`Conversion failed: ${error.message}`, "error");
                warpOutput.value = '';
                copyBtn.disabled = true;
            }
        };

        // --- UI Helper Functions ---

        /**
         * Displays a status message to the user.
         * @param {string} message - The message to display.
         * @param {'success' | 'error'} type - The type of message.
         */
        const showStatus = (message, type) => {
            statusMessage.textContent = message;
            if (type === 'success') {
                statusMessage.className = 'mt-6 text-center text-sm text-green-400';
            } else {
                statusMessage.className = 'mt-6 text-center text-sm text-red-400';
            }
        };

        /**
         * Handles the file upload event.
         * @param {Event} event - The file input change event.
         */
        const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    itermInput.value = e.target.result;
                    handleConvert();
                };
                reader.onerror = () => {
                    showStatus("Failed to read the file.", "error");
                };
                reader.readAsText(file);
            }
        };
        
        /**
         * Copies the generated YAML to the clipboard.
         */
        const handleCopy = () => {
            if (!warpOutput.value) return;
            
            // The navigator.clipboard API might not be available in all contexts,
            // so we use the older execCommand as a reliable fallback.
            const textarea = document.createElement('textarea');
            textarea.value = warpOutput.value;
            textarea.style.position = 'fixed'; // Avoid scrolling to bottom
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { 
                    copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg> Copy to Clipboard`;
                }, 2000);
            } catch (err) {
                showStatus('Failed to copy text.', 'error');
            }
            document.body.removeChild(textarea);
        };


        // --- Event Listeners ---
        convertBtn.addEventListener('click', handleConvert);
        fileUpload.addEventListener('change', handleFileUpload);
        copyBtn.addEventListener('click', handleCopy);

    </script>
</body>
</html>
